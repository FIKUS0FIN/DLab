# ============================================================================
# Copyright (c) 2016 EPAM Systems Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ============================================================================

FROM ubuntu:16.04

MAINTAINER Victor Andreev (victor_andreev@epam.com)

# Install any .deb dependecies
RUN	apt-get update && apt-get -y upgrade
RUN	apt-get -y install python-pip python-dev groff vim less git wget nano

# Install any python dependencies
RUN pip install boto3 fabric awscli boto argparse ujson jupyter

# Minimizing disk usage: will be usefull only with image flatteinig
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Configuring user
ARG SSH_CONFIG_DIR="/root/.ssh"
ARG SSH_CONFIG="${SSH_CONFIG_DIR}/config"

RUN mkdir -p ${SSH_CONFIG_DIR}
RUN echo "Host *" > ${SSH_CONFIG}
RUN echo "StrictHostKeyChecking no" >>  ${SSH_CONFIG}
RUN echo "UserKnownHostsFile=/dev/null" >> ${SSH_CONFIG}
RUN echo "GlobalKnownHostsFile=/dev/null" >> ${SSH_CONFIG}
RUN echo "ConnectTimeout=30" >> ${SSH_CONFIG}

# Configuring entrypoint script
ENV PROVISION_CONFIG_DIR /root/conf/
ENV KEYFILE_DIR /root/keys/
RUN mkdir -p /root/conf
COPY src/entrypoint.sh /bin/entrypoint.sh
RUN chmod a+x /bin/entrypoint.sh

# Entrypoint
ENTRYPOINT ["/bin/entrypoint.sh"]
